(()=>{"use strict";const e="GraphQL Client",t="An error occurred while fetching from the API. Review 'graphQLErrors' for details.",r="Response returned unexpected Content-Type:",s="An unknown error has occurred. The API did not return a data object or any errors in its response.",n="application/json",i="X-SDK-Variant",o="X-SDK-Version",a=[429,503],c=/@(defer)\b/i,u=/boundary="?([^=";]+)"?/i;function l(t,r=e){return t.startsWith(`${r}`)?t:`${r}: ${t}`}function d(e){return e instanceof Error?e.message:JSON.stringify(e)}function h(e){return e instanceof Error&&e.cause?e.cause:void 0}function p(e){return e.flatMap((({errors:e})=>e??[]))}function m({client:e,retries:t}){if(void 0!==t&&("number"!=typeof t||t<0||t>3))throw new Error(`${e}: The provided "retries" value (${t}) is invalid - it cannot be less than 0 or greater than 3`)}function y(e,t){return t&&("object"!=typeof t||Array.isArray(t)||"object"==typeof t&&Object.keys(t).length>0)?{[e]:t}:{}}function f(e,t){if(0===e.length)return t;const r=e.pop(),s={[r]:t};return 0===e.length?s:f(e,s)}function g(e,t){return Object.keys(t||{}).reduce(((r,s)=>("object"==typeof t[s]||Array.isArray(t[s]))&&e[s]?(r[s]=g(e[s],t[s]),r):(r[s]=t[s],r)),Array.isArray(e)?[...e]:{...e})}function S([e,...t]){return t.reduce(g,{...e})}function w({headers:t,url:s,customFetchApi:f=fetch,retries:g=0,logger:w}){m({client:e,retries:g});const A={headers:t,url:s,retries:g},k=function(e){return t=>{e&&e(t)}}(w),x=function(t,{url:r,headers:s,retries:n}){return async(a,c={})=>{const{variables:u,headers:l,url:d,retries:h,signal:p}=c,y=JSON.stringify({query:a,variables:u});m({client:e,retries:h});const f=Object.entries({...s,...l}).reduce(((e,[t,r])=>(e[t]=Array.isArray(r)?r.join(", "):r.toString(),e)),{});return f[i]||f[o]||(f[i]="shopify-graphql-client",f[o]="1.2.1"),t([d??r,{method:"POST",headers:f,body:y,signal:p}],1,h??n)}}(function({clientLogger:t,customFetchApi:r=fetch,client:s=e,defaultRetryWaitTime:n=1e3,retriableCodes:i=a}){const o=async(e,a,c)=>{const u=a+1,h=c+1;let p;try{if(p=await r(...e),t({type:"HTTP-Response",content:{requestParams:e,response:p}}),!p.ok&&i.includes(p.status)&&u<=h)throw new Error;return p}catch(r){if(u<=h){const r=p?.headers.get("Retry-After");return await async function(e){return new Promise((t=>setTimeout(t,e)))}(r?parseInt(r,10):n),t({type:"HTTP-Retry",content:{requestParams:e,lastResponse:p,retryAttempt:a,maxRetries:c}}),o(e,u,c)}throw new Error(l(`${c>0?`Attempted maximum number of ${c} network retries. Last message - `:""}${d(r)}`,s))}};return o}({customFetchApi:f,clientLogger:k,defaultRetryWaitTime:1e3}),A),E=function(e){return async(...t)=>{if(c.test(t[0]))throw new Error(l("This operation will result in a streamable response - use requestStream() instead."));try{const s=await e(...t),{status:i,statusText:o}=s,a=s.headers.get("content-type")||"";return s.ok?a.includes(n)?v(s):{errors:{networkStatusCode:i,message:l(`${r} ${a}`),response:s}}:{errors:{networkStatusCode:i,message:l(o),response:s}}}catch(e){return{errors:{message:d(e)}}}}}(x),$=function(e){return async(...t)=>{if(!c.test(t[0]))throw new Error(l("This operation does not result in a streamable response - use request() instead."));try{const s=await e(...t),{statusText:i}=s;if(!s.ok)throw new Error(i,{cause:s});const o=s.headers.get("content-type")||"";switch(!0){case o.includes(n):return function(e){return{async*[Symbol.asyncIterator](){const t=await v(e);yield{...t,hasNext:!1}}}}(s);case o.includes("multipart/mixed"):return function(e,t){const r=(t??"").match(u),s=`--${r?r[1]:"-"}`;if(!e.body?.getReader&&!e.body[Symbol.asyncIterator])throw new Error("API multipart response did not return an iterable body",{cause:e});const n=async function*(e){const t=new TextDecoder;if(e.body[Symbol.asyncIterator])for await(const r of e.body)yield t.decode(r);else{const r=e.body.getReader();let s;try{for(;!(s=await r.read()).done;)yield t.decode(s.value)}finally{r.cancel()}}}(e);let i,o={};return{async*[Symbol.asyncIterator](){try{let e=!0;for await(const t of function(e,t){return{async*[Symbol.asyncIterator](){try{let r="";for await(const s of e)if(r+=s,r.indexOf(t)>-1){const e=r.lastIndexOf(t),s=r.slice(0,e).split(t).filter((e=>e.trim().length>0)).map((e=>e.slice(e.indexOf("\r\n\r\n")+4).trim()));s.length>0&&(yield s),r=r.slice(e+t.length),"--"===r.trim()&&(r="")}}catch(e){throw new Error(`Error occured while processing stream payload - ${d(e)}`)}}}}(n,s)){const r=q(t);i=r.find((e=>e.extensions))?.extensions??i;const s=p(r);o=S([o,...r.map((({data:e})=>e))]),e=r.slice(-1)[0].hasNext,b(s,o),yield{...y("data",o),...y("extensions",i),hasNext:e}}if(e)throw new Error("Response stream terminated unexpectedly")}catch(t){const r=h(t);yield{...y("data",o),...y("extensions",i),errors:{message:l(d(t)),networkStatusCode:e.status,...y("graphQLErrors",r?.graphQLErrors),response:e},hasNext:!1}}}}}(s,o);default:throw new Error(`${r} ${o}`,{cause:s})}}catch(e){return{async*[Symbol.asyncIterator](){const t=h(e);yield{errors:{message:l(d(e)),...y("networkStatusCode",t?.status),...y("response",t)},hasNext:!1}}}}}}(x);return{config:A,fetch:x,request:E,requestStream:$}}async function v(e){const{errors:r,data:n,extensions:i}=await e.json();return{...y("data",n),...y("extensions",i),headers:e.headers,...r||!n?{errors:{networkStatusCode:e.status,message:l(r?t:s),...y("graphQLErrors",r),response:e}}:{}}}function q(e){return e.map((e=>{try{return JSON.parse(e)}catch(e){throw new Error(`Error in parsing multipart response - ${d(e)}`)}})).map((e=>{const{data:t,incremental:r,hasNext:s,extensions:n,errors:i}=e;if(!r)return{data:t||{},...y("errors",i),...y("extensions",n),hasNext:s};const o=r.map((({data:e,path:t,errors:r})=>({data:e&&t?f(t,e):{},...y("errors",r)})));return{data:1===o.length?o[0].data:S([...o.map((({data:e})=>e))]),...y("errors",p(o)),hasNext:s}}))}function b(e,r){if(e.length>0)throw new Error(t,{cause:{graphQLErrors:e}});if(0===Object.keys(r).length)throw new Error(s)}function A({client:e,currentSupportedApiVersions:t,apiVersion:r,logger:s}){const n=`${e}: the provided apiVersion ("${r}")`,i=`Currently supported API versions: ${t.join(", ")}`;if(!r||"string"!=typeof r)throw new Error(`${n} is invalid. ${i}`);const o=r.trim();t.includes(o)||(s?s({type:"Unsupported_Api_Version",content:{apiVersion:r,supportedApiVersions:t}}):console.warn(`${n} is likely deprecated or not supported. ${i}`))}function k(e){const t=3*e-2;return 10===t?t:`0${t}`}function x(e,t,r){const s=t-r;return s<=0?`${e-1}-${k(s+4)}`:`${e}-${k(s)}`}const E="application/json",$="X-Shopify-Storefront-Access-Token",I="Shopify-Storefront-Private-Token",T="X-SDK-Variant",V="X-SDK-Version",L="X-SDK-Variant-Source",z="Storefront API Client";class C extends(window.Herd.SparkElement()){constructor(){super(),this.steps=this.querySelectorAll("quiz-step"),this.formData=JSON.parse(this.dataset.formData),this.currentStep=0}connectedCallback(){this._hasBeenInitialised||(this._hasBeenInitialised=!0,this.showStep(this.currentStep),this.setupListeners())}setupListeners(){this.nextStep=this.nextStep.bind(this),this.prevStep=this.prevStep.bind(this),this.els.next&&this.els.next.elements.forEach((e=>{this.listeners.add(e,"click",this.nextStep)})),this.els.prev&&this.listeners.add(this.els.prev.element,"click",this.prevStep)}validateStep(e){let t=!0;const r=e.querySelector("[data-validation]"),s=e.querySelector("[data-validation-max-checks]");if("true"!==e.getAttribute("data-requires-validation"))return!0;try{const n=e.querySelector("quiz-question");if(!n)return!0;const i=parseInt(n.dataset?.maxOptionSelection??"0",10),o=n.querySelectorAll(".form-input");let a=0;o.forEach((e=>{"checkbox"!==e.type&&"radio"!==e.type||!e.checked||a++}));const c=a>0;if(i>0&&a<=i&&a>0)return t=!0,s&&s.setAttribute("hidden",!0),t;if(s&&i>0)return t=!1,s.removeAttribute("hidden"),t;if(c){if(r)return t=!0,r.setAttribute("hidden",!0),t}else if(t=!1,r)return r.removeAttribute("hidden"),t;return t}catch(e){return console.error("Validation error:",e),!1}}prevStep(){0!==this.currentStep&&(this.currentStep--,this.checkStepPassesConditions(this.currentStep)?this.showStep(this.currentStep):this.prevStep())}nextStep(){const e=this.steps[this.currentStep];this.validateStep(e)&&(this.currentStep!==this.steps.length-1?(this.currentStep++,this.checkStepPassesConditions(this.currentStep)?this.showStep(this.currentStep):this.nextStep()):this.showResults())}checkStepPassesConditions(e){return this.steps[e].checkConditions()}showStep(e){this.steps.forEach(((t,r)=>{r===e?t.removeAttribute("hidden"):t.setAttribute("hidden",!0)})),this.els.progressBar.element.scrollIntoView(),this.updateProgressBar(),this.els.prev&&(0===e?this.els.prev.element.setAttribute("hidden",!0):this.els.prev.element.removeAttribute("hidden"))}updateProgressBar(){const e=this.steps.length,t=(this.currentStep+1)/e*100;this.els.progressBar.element.value=t}hideProgressBar(){this.els.progressBar.element.setAttribute("hidden",!0)}showResults(){this.els.next.element.setAttribute("hidden",!0),this.els.prev.element.setAttribute("hidden",!0),this.steps.forEach((e=>{e.setAttribute("hidden",!0)})),this.hideProgressBar();const e=this.querySelector("quiz-results");e.removeAttribute("hidden"),e.run()}}class R extends(window.Herd.SparkElement()){constructor(){super(),this.conditionalLogic=JSON.parse(this.dataset.conditionalLogic??"{}"),this.quizForm=this.closest("quiz-form")}checkConditions(){return!this.conditionalLogic||0==this.conditionalLogic.conditions.length||("all"===this.conditionalLogic.match_type?this.conditionalLogic.conditions.every((e=>this.checkCondition(e))):this.conditionalLogic.conditions.some((e=>this.checkCondition(e))))}checkCondition(e){const t=this.quizForm.querySelector(`quiz-question[key="${e.key}"]`);if(!t)return!1;switch(e.operator){case"equal_to":return t.value===e.value;case"not_equal_to":return t.value!==e.value;case"contains":return t.value.includes(e.value);case"does_not_contain":return!t.value.includes(e.value);case"starts_with":return t.value.startsWith(e.value);case"ends_with":return t.value.endsWith(e.value)}}}class P extends(window.Herd.SparkElement()){constructor(){super()}get value(){return this.getValueExtractor()}getValueExtractor(){switch(this.dataset.questionType){case"email":return this.getEmailValue();case"text":return this.getTextValue();case"radio":return this.getRadioValue();case"checkboxes":return this.getCheckboxesValue();default:return()=>!1}}getEmailValue(){return this.querySelector('input[type="email"]').value}getTextValue(){return this.querySelector('input[type="text"]').value}getRadioValue(){const e=this.querySelector('input[type="radio"]:checked');return e?e.value:null}getCheckboxesValue(){const e=this.querySelectorAll('input[type="checkbox"]:checked');return Array.from(e).map((e=>e.name))}}class F extends(window.Herd.SparkElement()){constructor(){super(),this.quizForm=this.closest("quiz-form"),this.client=function({storeDomain:e,apiVersion:t,publicAccessToken:r,privateAccessToken:s,clientName:n,retries:i=0,customFetchApi:o,logger:a}){const c=function(){const{year:e,quarter:t,version:r}=function(){const e=new Date,t=e.getUTCMonth(),r=e.getUTCFullYear(),s=Math.floor(t/3+1);return{year:r,quarter:s,version:`${r}-${k(s)}`}}(),s=4===t?`${e+1}-01`:`${e}-${k(t+1)}`;return[x(e,t,3),x(e,t,2),x(e,t,1),r,s,"unstable"]}(),u=function({client:e,storeDomain:t}){try{if(!t||"string"!=typeof t)throw new Error;const e=t.trim(),r=e.match(/^https?:/)?e:`https://${e}`,s=new URL(r);return s.protocol="https",s.origin}catch(r){throw new Error(`${e}: a valid store domain ("${t}") must be provided`,{cause:r})}}({client:z,storeDomain:e}),l={client:z,currentSupportedApiVersions:c,logger:a};A({...l,apiVersion:t}),function(e,t){if(!e&&!t)throw new Error(`${z}: a public or private access token must be provided`);if(e&&t)throw new Error(`${z}: only provide either a public or private access token`)}(r,s),function(e){if(e&&"undefined"!=typeof window)throw new Error(`${z}: private access tokens and headers should only be used in a server-to-server implementation. Use the public API access token in nonserver environments.`)}(s);const d=function(e,t,r){return s=>{s&&A({...r,apiVersion:s});const n=(s??t).trim();return`${e}/api/${n}/graphql.json`}}(u,t,l),h={storeDomain:u,apiVersion:t,...r?{publicAccessToken:r}:{privateAccessToken:s},headers:{"Content-Type":E,Accept:E,[T]:"storefront-api-client",[V]:"1.0.3",...n?{[L]:n}:{},...r?{[$]:r}:{[I]:s}},apiUrl:d(),clientName:n},p=w({headers:h.headers,url:h.apiUrl,retries:i,customFetchApi:o,logger:a}),m=function(e){return t=>({...t??{},...e.headers})}(h),y=function(e,t){return r=>r?t(r):e.apiUrl}(h,d),f=function({getHeaders:e,getApiUrl:t}){return(r,s)=>{const n=[r];if(s&&Object.keys(s).length>0){const{variables:r,apiVersion:i,headers:o,retries:a}=s;n.push({...r?{variables:r}:{},...o?{headers:e(o)}:{},...i?{url:t(i)}:{},...a?{retries:a}:{}})}return n}}({getHeaders:m,getApiUrl:y}),g={config:h,getHeaders:m,getApiUrl:y,fetch:(...e)=>p.fetch(...f(...e)),request:(...e)=>p.request(...f(...e)),requestStream:(...e)=>p.requestStream(...f(...e))};return Object.freeze(g)}({storeDomain:"https://naturalkik.myshopify.com",apiVersion:"2025-04",publicAccessToken:"fd1a28f413010d04670dbe3b5740c5cd"})}async run(){await this.renderResultsSection(),this.attachToggleListeners(),this.attachRemoveListeners(),this.updateOrderSummary(),console.log("sections",this.innerHTML)}attachToggleListeners(){this.querySelectorAll(".select-toggle").forEach((e=>{e.addEventListener("click",(()=>{if(e.classList.contains("locked"))return;const t="true"===e.dataset.selected,r=e.closest(".snippet-card-product-quiz"),s=r.dataset.variantId,n=e.querySelector("span");if(!t){e.dataset.selected="true",e.classList.add("selected"),e.setAttribute("aria-pressed","true"),n.textContent="Selected";const t=r.querySelector(`.remove-item[data-variant-id="${s}"]`);t&&(t.style.display="inline")}this.updateOrderSummary()}))}))}attachRemoveListeners(){this.querySelectorAll(".remove-item").forEach((e=>{const t=e.dataset.variantId;e.addEventListener("click",(e=>{const r=this.querySelector(`.snippet-card-product-quiz[data-variant-id="${t}"]`),s=r?.querySelector(".select-toggle"),n=r?.querySelector(`.remove-item[data-variant-id="${t}"]`),i=s.querySelector("span");s&&(s.dataset.selected="false",s.classList.remove("selected"),s.setAttribute("aria-pressed","false"),i.textContent="Add to Plan"),n&&(n.style.display="none"),this.updateOrderSummary()}))}))}async updateOrderSummary(){const e=[];this.querySelectorAll(".snippet-card-product-quiz").forEach((t=>{const r=t.querySelector(".select-toggle"),s=t.dataset.index;("true"===r.dataset.selected||"0"===s)&&e.push(t.dataset.variantId)}));const t=e.join(","),r=`https://www.hairburst.com?section_id=data-quiz-results&handles=${e.map((e=>{const t=this.querySelector(`.snippet-card-product-quiz[data-variant-id="${e}"]`);return t?.querySelector(".title")?.href.split("/products/")[1]||""})).filter(Boolean).join(",")}&ids=${t}`;try{const e=await window.Herd.utils.sectionRenderer.fetchSingle("data-quiz-results",r),t=document.createElement("div");t.innerHTML=e;const s=t.querySelector(".order-summary"),n=this.querySelector(".order-summary");s&&n&&(n.replaceWith(s),this.form=s.querySelector("form"),this.form.addEventListener("submit",this.onFormSubmission.bind(this)),this.attachRemoveListeners(),this.attachToggleListeners())}catch(e){console.error("Failure to update order summary card via section rendering:",e)}}getResultsFromForm(){const e={};return this.quizForm.steps.forEach((t=>{const r=t.querySelector("quiz-question");if(r){const t=r.value;e[r.key]=null==t?"":t}})),console.log("Normalized quiz results:",e),e}getWeightedVariantsFromResults(){const e=this.getResultsFromForm?.()??{},t=Array.isArray(this?.quizForm?.formData?.steps)?this.quizForm.formData.steps:[],r=new Map,s=(e,t={})=>console.warn(`[Quiz] ${e}`,t);return t.forEach(((t,n)=>{t&&!t.isFullStepContent&&Array.isArray(t.questions)?t.questions.forEach(((t,i)=>{if(!t)return void s("Skipping empty question",{sIdx:n,qIdx:i});const o=t.type,a=t.key;if(!a||!["checkboxes","radio"].includes(o))return;const c=e[a];if(null==c||Array.isArray(c)&&0===c.length)return;const u=Array.isArray(c)?c.filter(Boolean):[c];Array.isArray(t.options)?u.forEach((e=>{const o=t.options.find((t=>t&&t.value===e));if(!o)return void s("Answer not found in options",{sIdx:n,qIdx:i,key:a,answer:e});const c=Array.isArray(o.recommendedProducts)?o.recommendedProducts:[];0!==c.length?c.forEach(((t,o)=>{const c=String(t?.variantId??"").trim(),u=Number.isFinite(t?.weight)?t.weight:0;c?r.set(c,(r.get(c)??0)+u):s("Missing variantId in recommendedProduct",{sIdx:n,qIdx:i,rIdx:o,key:a,answer:e})})):s("Option has no recommendedProducts",{sIdx:n,qIdx:i,key:a,answer:e})})):s("Question has no options array",{sIdx:n,qIdx:i,key:a})})):s("Skipping non-question step",{sIdx:n,stepId:t?.id})})),0===r.size?s("No weighted variants produced from current answers."):console.log("weightedVariants",Object.fromEntries([...r.entries()].sort(((e,t)=>t[1]-e[1])))),[...r.entries()].sort(((e,t)=>t[1]-e[1])).map((([e])=>e))}async getVariantsFromStrorefrontApi(){const e=this.getWeightedVariantsFromResults(),{data:t,errors:r,extensions:s}=await this.client.request("\n      query ($ids: [ID!]!) {\n        nodes(ids: $ids) {\n          ... on ProductVariant {\n            id\n            product {\n              handle\n              productType\n            }\n          }\n        }\n      }\n    ",{variables:{ids:this.mapShopifyVariantIds(e)}});return console.log("data",t.nodes),t.nodes}async getVariantsByProductType(){const e=await this.getVariantsFromStrorefrontApi(),t=this.quizForm.formData.results.productTypeList,r=[];return console.log("variantsFromStorefront",e),t.forEach((t=>{e.filter((e=>e&&e.product.productType===t.productType)).slice(0,t.quantity).forEach((e=>{r.push({handle:e.product.handle,id:e.id})}))})),console.log("Variant Details:",r),r}async fetchResultsSection(){const e=await this.getVariantsByProductType(),t=this.getCommaSeparatedValues(e,"handle"),r=this.getCommaSeparatedValues(e,"id",!0),s=await window.Herd.utils.sectionRenderer.fetchSingle("data-quiz-results",`https://www.hairburst.com?handles=${t}&ids=${r}`);return console.log("section",s),s}getCommaSeparatedValues(e,t,r=!1){return e.map((e=>{let s=e[t];return r&&"string"==typeof s&&(s=s.replace(/^gid:\/\/shopify\/ProductVariant\//,"")),s})).filter((e=>null!=e)).join(",")}async renderResultsSection(){const e=await this.fetchResultsSection();console.log("section",e),this.innerHTML=e,this.initRatingSnippet(),console.log("this.innerHTML",this.innerHTML),console.log("this",this),this.form=this.querySelector("form"),this.form.addEventListener("submit",this.onFormSubmission.bind(this))}initRatingSnippet(){this.querySelectorAll(".ruk_rating_snippet").length>0&&ratingSnippet("ruk_rating_snippet",{store:"naturalkik.myshopify.com",mode:"default",color:"#343436",linebreak:!1,text:"reviews",singularText:"review",lang:"en",usePolaris:!1,showEmptyStars:!1})}mapShopifyVariantIds(e){return e.map((e=>`gid://shopify/ProductVariant/${e}`))}onFormSubmission(e){e.preventDefault(),console.log("formItems",this.createItemData());try{return window.Herd.Cart.addItems(this.createItemData(),{sections:window.Herd.utils.sectionRenderer.popoutCartSections.map((e=>e.section)),sectionsUrl:window.location.pathname})}catch(e){return this.handleAddToCartError(e,this.createItemData())}}async handleAddToCartError(e,t){console.log(e,t)}createItemData(){return console.log("this.form",this.form),this.form.dataset.variantIds.split(",").reduce(((e,t)=>(e.push({id:t,quantity:1}),e)),[])}}customElements.get("quiz-form")||customElements.define("quiz-form",C),customElements.get("quiz-step")||customElements.define("quiz-step",R),customElements.get("quiz-question")||customElements.define("quiz-question",P),customElements.get("quiz-results")||customElements.define("quiz-results",F)})();