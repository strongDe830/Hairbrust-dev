{% liquid
  assign template_name = 'snippet-layout-product-form'
  assign product_form_id = 'product-form-' | append: _section.id
  assign variant = _product.selected_or_first_available_variant
  assign _current_variant_id = variant.id

  assign additional_review_products = _product.metafields.custom.additional_review_products
  assign product_skus = product.variants | map: 'sku' | join: ';' | append: additional_review_products | prepend: ';'
  assign lozenges = product.metafields.custom.product_lozenges.value
  assign trust_points = product.metafields.custom.trust_points.value
  assign short_desc = product.metafields.custom.short_description | metafield_tag
  assign product_information = product.metafields.custom.product_information.value
  assign force_out_of_stock = product.metafields.custom.force_out_of_stock
  assign alt_variant = product.metafields.custom.alternative_purchase_option.value

  assign free_gift = variant.metafields.custom.free_gift.value

  assign disclaimer = section.blocks | where: 'type', 'disclaimer' | first
  assign complementary_blocks = _section.blocks | where: 'type', 'complementary'

  assign available = false
  if variant.inventory_policy == 'continue' or variant.available
    assign available = true
  endif

  assign bundle_products = product.metafields.bundle.bundle_products.value
  if bundle_products != blank
    assign bundle_array = '' | split: ''
    for bundle_product in bundle_products
      assign nested_bundle_products = bundle_product.metafields.bundle.bundle_products.value
      if nested_bundle_products != blank
        for nested_product in nested_bundle_products
          assign nested_bundle_skus = nested_product.variants | map: 'sku' | append: ',' | split: ','
          assign bundle_array = bundle_array | concat: nested_bundle_skus | join: ','
        endfor
      else
        assign bundle_skus = bundle_product.variants | map: 'sku' | append: ',' | split: ','
        assign bundle_array = bundle_array | concat: bundle_skus | join: ','
      endif
    endfor
    assign product_skus = bundle_array | uniq | remove: '[' | remove: ']' | remove: '\' | replace: ',', ';' | remove: '"' | append: additional_review_products
  endif

  assign bogo_this_variant_enabled = false
  assign bogo_shop_sale_enabled = false
  assign bogo_sale_excluded_variants = ''
  assign bogo_enabled = shop.metaobjects.bogo_sale_enabled_.values
  for entry in bogo_enabled limit: 1
    assign bogo_shop_sale_enabled = entry.enabled
  endfor

  assign bogo_excluded_variants = shop.metaobjects.bogo_sale_excluded_variants.values
  for entry in bogo_excluded_variants limit: 1
    assign bogo_sale_excluded_variants = entry.variants.value
  endfor

  if bogo_shop_sale_enabled == true
    assign bogo_this_variant_enabled = true
    for excluded_variant in bogo_sale_excluded_variants
      if excluded_variant.id == _current_variant_id
        assign bogo_this_variant_enabled = false
      endif
    endfor
  endif

  render 'file-css', _name: 'snippet-layout-product-form.css'
  render 'file-js', _name: 'snippet-layout-product-form.js', _load_type: 'defer'
  render 'file-js', _name: 'snippet-data-product-variants.js', _load_type: 'defer'
%}

<product-form
  class="{{ template_name }}"
  id="layout-product-form-{{section.id}}"
>
  {%- form 'product', product, id: product_form_id, data-product-form: '' -%}
    <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">
    <input
      type="number"
      name="quantity"
      class="form-input"
      value="1"
      data-cart-line-item-el="quantity"
      hidden
    >
    {% if free_gift != blank %}
      <div data-free-gift-id="{{ free_gift.selected_or_first_available_variant.id }}" hidden></div>
    {% endif %}
    
    <div id="bogo-{{- section.id -}}" data-bogof hidden>
      {% if bogo_this_variant_enabled %}
        <div data-bogo-enabled hidden></div>
        <input type="hidden" name="properties[__bogof]" value="__bogof">
      {% endif %}
    </div>

    {%- for block in section.blocks -%}
      {%- case block.type -%}
        {%- when '@app' -%}
          {% render block %}

        {%- when 'heading' -%}
           <a
            href="#product-reviews"
            aria-label="{{- 'products.product.view_reviews' | t -}}"
            class="ruk_rating_snippet"
            data-sku="{{- product_skus -}}"
          ></a>
          <h1 class="u-heading-md product-title" id="product-form-title-{{ _section.id }}">{{- _product.title }}</h1>
         

        {%- when 'short_desc' -%}
          {% if short_desc != blank %}
            <div class="product-short-desc">
              <p>{{ short_desc }}</p>
              {% comment %} {%- if product_information != blank -%}
                <a href="#product-info" class="read-more">{{- 'buttons.read_more' | t -}}</a>
              {%- endif -%} {% endcomment %}
            </div>
          {% endif %}

        {%- when 'price' -%}
          {%- unless _product.options contains 'Subscription Option' -%}
            {%- render 'data-prices', _product: product, _variant: variant, _section: section -%}
          {%- endunless -%}

        {%- when 'trust_points' -%}
          {% if trust_points.count > 0 %}
            <ul class="trust-points">
              {% for trust_point in trust_points %}
                {% liquid
                  assign named_bg_colour = trust_point.background_colour
                  assign background_colour = blank
                  case named_bg_colour
                    when 'Peep Pink'
                      assign background_colour = 'we-peep'
                    when 'Tuna Grey'
                      assign background_colour = 'tuna'
                    when 'Gallery White'
                      assign background_colour = 'gallery'
                  endcase
                %}
                <li
                  {% if background_colour != blank %}
                    class="alt {{ background_colour }}"
                  {% endif %}
                >
                  {% if trust_point.icon != blank %}
                    {{ trust_point.icon | image_url: width: 80 | image_tag: class: 'icon', loading: 'lazy' }}
                  {% endif %}
                  {{ trust_point.text }}
                  {% if background_colour != blank and trust_point.extra_text %}
                    <span class="extra-text">{{ trust_point.extra_text }}</span>
                  {% endif %}
                </li>
              {% endfor %}
            </ul>
          {% endif %}

        {%- when 'variants' -%}
          {%- render 'data-product-variants',
            _product: _product,
            _product_form_id: product_form_id,
            _selected_variant: variant,
            _current_variant_id: _current_variant_id,
            _section: _section,
            _alt_variant: alt_variant
          -%}

        {%- when 'lozenges' -%}
          {% if lozenges.count > 0 %}
            <ul class="c-lozenges">
              {% for lozenge in lozenges %}
                {% liquid
                  assign named_bg_colour = lozenge.background_colour
                  assign background_colour = blank
                  case named_bg_colour
                    when 'Peep Pink'
                      assign background_colour = 'we-peep'
                    when 'Tuna Grey'
                      assign background_colour = 'tuna'
                    when 'Gallery White'
                      assign background_colour = 'gallery'
                        when 'White'
                        assign background_colour = 'pure-White'
                             when 'Pale Rose'
                        assign background_colour = 'Pale Rose'
                  endcase
                  assign border = lozenge.border | default: false
                %}
                <li  style="background-color:rgb({{lozenge.background_color_new.value.red}} {{lozenge.background_color_new.value.green}} {{lozenge.background_color_new.value.blue}} / {{lozenge.background_color_opacity  |default:100}}%); !important;color:{{lozenge.text_color}} !important;{%if border %}border:1px solid #000 !important;{% else %}border:unset !important;{%endif %}"  class="c-lozenge {{ background_colour }} {% if border %}border{% endif %}">{{ lozenge.text }}</li>
              {% endfor %}
            </ul>
          {% endif %}

        {%- when 'customer_q_and_a' -%}
          {%- if block.settings.question != blank and block.settings.answer != blank -%}
            <div class="product-q-and-a" {{ block.shopify_attributes }}>
              <div class="product-q-and-a_question">
                {{- block.settings.question -}}
              </div>
              <div class="product-q-and-a__answer">
                {{- block.settings.answer -}}
              </div>
            </div>
          {%- endif -%}

        {%- when 'buy_button' -%}
          <button
            class="c-btn main tuna add-to-basket"
            data-product-add-to-cart
            data-product-submit-button
            {% if available == false or force_out_of_stock == true %}
              disabled
            {% endif %}
            id="submit-button-{{ _section.id }}"
          >
            {%- if available == false or force_out_of_stock == true -%}
              <span data-product-add-to-cart-text>{{- 'products.product.sold_out' | t -}}</span>
            {%- else -%}
              <span data-product-add-to-cart-text>{{- 'products.product.add_to_cart' | t -}}</span>
              <svg width="13" height="11" viewBox="0 0 13 11" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12.3579 5.88345L7.50847 10.7329C7.40129 10.8401 7.25548 10.8999 7.1031 10.8991C6.95073 10.8983 6.80428 10.837 6.69597 10.7286C6.58766 10.6203 6.52637 10.4739 6.52557 10.3215C6.52477 10.1691 6.58453 10.0233 6.69171 9.91614L10.5655 6.04231L0.577484 5.98995C0.425114 5.98914 0.278672 5.92783 0.170374 5.81951C0.0620766 5.7112 0.00079433 5.56475 8.58635e-06 5.41238C-0.000777147 5.26001 0.058999 5.1142 0.166185 5.00703C0.273372 4.89986 0.419189 4.84011 0.57156 4.84092L10.5595 4.89329L6.64486 0.978626C6.53655 0.870317 6.47525 0.723866 6.47445 0.571493C6.47365 0.419119 6.53342 0.273304 6.6406 0.166124C6.74778 0.0589448 6.89359 -0.000819254 7.04597 -2.04345e-05C7.19834 0.000778383 7.34479 0.0620747 7.4531 0.170384L12.3537 5.07095C12.3554 5.07265 12.3564 5.07466 12.3581 5.07633C12.383 5.10172 12.4057 5.12935 12.4256 5.15885C12.4354 5.17346 12.4422 5.18927 12.4506 5.20453C12.4728 5.23859 12.4886 5.27638 12.4972 5.31603C12.5022 5.33257 12.5087 5.34847 12.5122 5.3656C12.5197 5.40231 12.5236 5.43964 12.524 5.47704L12.5241 5.47803C12.5242 5.51585 12.5206 5.55356 12.5133 5.59059C12.5101 5.60719 12.5039 5.6225 12.4993 5.63857C12.491 5.67883 12.4754 5.71714 12.4531 5.75157C12.445 5.76645 12.4385 5.78194 12.429 5.79622C12.4083 5.8276 12.3845 5.85682 12.3579 5.88345Z" fill="#FDFDFD"/>
          </svg>
            {%- endif -%}
          </button>

       {%- when 'payment-icons' -%}
          <div class="cs-payment-icon">
            {% if block.settings.text  %}
          <span>{{block.settings.text }}</span>
          {% endif %}
       
        <img src="{{ 'payment-icon.svg' | asset_url }}" alt="Payment Icon" class="payment-icon">
       
          </div>

        {%- when 'aboutadvance' -%}

          <div class="about-advance-plus cs-container">
              <!-- About Section -->
            {% if product.metafields.custom.about_advance.value %}
              <div class="about-advance-wrapper">

                {% for item in product.metafields.custom.about_advance.value %}
                  <div class="about-advance-block">
                    {%if item.title   %}
                    <h3 style="color:{{ block.settings.textcolor }}"  class="title-advance-plus">{{ item.title }}</h3>
                    {%endif %}
                    {% if  item.description  %}
                      <div style="color:{{ block.settings.textcolor }}" class="advanceplus-description">{{ item.description }}</div>
                    {%endif %}

                    {% if item.badges and item.badges.value %}
                      <ul class="badges-list">
                        {% for badge in item.badges.value %}
                          <li style="background-color:{{ block.settings.badgebgcolor }};color:{{ block.settings.badgecolor }}">{{ badge }}</li>
                        {% endfor %}
                      </ul>
                    {% endif %}

                  </div>
                {% endfor %}

              </div>
            {% endif %}
          </div>

        {% when 'how-to-use' %}
              <!-- How to Use Section -->
          {% assign how_to_use = product.metafields.custom.how_to_use.value %}
          {% if how_to_use %}
            <div style="background-color:{{block.settings.bg_color }};" class="how-to-use">

                <!-- TITLE -->
                {%if how_to_use.title != blank %}
                <h3 class="howtouse-title">{%if block.settings.svg_icon%}<span class="svg_icon_custom-how-to">{{block.settings.svg_icon}}</span>{%endif%}{{ how_to_use.title }}</h3>
                {%endif %}

                <!-- TAGS (List or Single both supported) -->
                {% if how_to_use.tags %}
                    <div class="badges">

                        {% if how_to_use.tags.value %}
                            {% for tag in how_to_use.tags.value %}
                                <span style="background-color:{{ block.settings.badgebgcolor }};color:{{ block.settings.badgecolor }}" class="badge">{{ tag }}</span>
                            {% endfor %}
                        {% else %}
                            <span class="badge">{{ how_to_use.tags }}</span>
                        {% endif %}

                    </div>
                {% endif %}




                <!-- DESCRIPTIONS -->{% if how_to_use.description %}
                <div class="custom-description">{{ how_to_use.description |metafield_tag }}</div>
                {%endif %}


                <!-- CAPSULE TEXT -->
                {%if how_to_use.capsules_text != blank %}
                <div style="color:{{block.settings.capsule_text_color }};background-color:{{block.settings.capsule_bg_color }};" class="capsules">{{ how_to_use.capsules_text }}</div>
                {%endif %}

            </div>
          {% endif %}


        {% when 'tabs' %}

          {% assign accordion = product.metafields.custom.accordion_data.value %}

          {% if accordion %}

            <div class="accordion-wrapper">
              {% if accordion.haier.value %}
                <div class="hair-accordian-wrap">
                  <div class="title-hair-tab comman-pdp-tab-title">
                    {{ accordion.hair_tab_title | default: 'Hair' }}
                    <span class="tab-icon">
                      <!-- Plus -->
                      <svg class="icon-plus" width="10" height="10" viewBox="0 0 10 10" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <line x1="5.05469" y1="0.000492452" x2="5.04483" y2="10.0005" stroke="#FDFDFD"/>
                        <line x1="10.0001" y1="5.04529" x2="0.000110576" y2="5.04751" stroke="#FDFDFD"/>
                      </svg>
                      <!-- Minus -->
                      <svg class="icon-minus" width="10" height="1" viewBox="0 0 10 1" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <line x1="10.0001" y1="0.5" x2="0.000110576" y2="0.502219" stroke="#FDFDFD"/>
                      </svg>
                    </span>
                  </div>

                  <div class="pdp-tab-content-comman hair-tab-pdp">
                    <div class="accordian-inner-content">
                 {% for field in accordion.haier.value %}
                    <span class="hair-points-wrap">
                    {%if field.svg_icon %}
                        <span class="svg-icon-hair-points">{{field.svg_icon }}</span>
                        {%endif %}
                        {%if field.text %}
                      <span class="hair-tab-points">{{ field.text }}</span>
                      {%endif %}
                    </span>
                    {% endfor %}
                    </div>
                   
                  </div>
                </div>
              {% endif %}

              {% if accordion.body != blank %}
                <div class="body-accordian-wrap">
                  <div class="title-body-tab comman-pdp-tab-title">
                    {{ accordion.body_tab_title | default: 'Body' }}
                    <span class="tab-icon">
                      <!-- Plus -->
                      <svg class="icon-plus" width="10" height="10" viewBox="0 0 10 10" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <line x1="5.05469" y1="0.000492452" x2="5.04483" y2="10.0005" stroke="#FDFDFD"/>
                        <line x1="10.0001" y1="5.04529" x2="0.000110576" y2="5.04751" stroke="#FDFDFD"/>
                      </svg>
                      <!-- Minus -->
                      <svg class="icon-minus" width="10" height="1" viewBox="0 0 10 1" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <line x1="10.0001" y1="0.5" x2="0.000110576" y2="0.502219" stroke="#FDFDFD"/>
                      </svg>
                    </span>
                  </div>
                  <div class="pdp-tab-content-comman body-tab-pdp">
                       <div class="accordian-inner-content">
                    {{ accordion.body | metafield_tag }}
                       </div>
                  </div>
                </div>
              {% endif %}

              {% if accordion.benifits != blank %}
                <div class="benefits-accordian-wrap">
                  <div class="title-benefits-tab comman-pdp-tab-title">
                    {{ accordion.benifits_tab_title | default: 'Benefits' }}
                    <span class="tab-icon">
                      <!-- Plus -->
                      <svg class="icon-plus" width="10" height="10" viewBox="0 0 10 10" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <line x1="5.05469" y1="0.000492452" x2="5.04483" y2="10.0005" stroke="#FDFDFD"/>
                        <line x1="10.0001" y1="5.04529" x2="0.000110576" y2="5.04751" stroke="#FDFDFD"/>
                      </svg>
                      <!-- Minus -->
                      <svg class="icon-minus" width="10" height="1" viewBox="0 0 10 1" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <line x1="10.0001" y1="0.5" x2="0.000110576" y2="0.502219" stroke="#FDFDFD"/>
                      </svg>
                    </span>
                  </div>
                  <div class="pdp-tab-content-comman benefits-tab-pdp">
                       <div class="accordian-inner-content">
                    {{ accordion.benifits | metafield_tag }}
                       </div>
                  </div>
                </div>
              {% endif %}
            </div>

<script>
document.addEventListener("DOMContentLoaded", function () {

  // Hide all tab contents initially
  document.querySelectorAll(".pdp-tab-content-comman").forEach(el => {
    el.classList.remove("active");
  });

  // Default: Open hair tab OR first tab
  const hairTab = document.querySelector(".hair-tab-pdp");
  if (hairTab) {
    hairTab.classList.add("active");
    const hairTitle = document.querySelector(".title-hair-tab");
    hairTitle.classList.add("active");
    hairTitle.querySelector(".icon-plus").style.display = "none";
    hairTitle.querySelector(".icon-minus").style.display = "block";
  } else {
    const firstTitle = document.querySelector(".comman-pdp-tab-title");
    const firstContent = firstTitle.nextElementSibling;

    firstTitle.classList.add("active");
    firstContent.classList.add("active");
    firstTitle.querySelector(".icon-plus").style.display = "none";
    firstTitle.querySelector(".icon-minus").style.display = "block";
  }

  // Tab click functionality
  document.addEventListener("click", function (e) {
    const tab = e.target.closest(".comman-pdp-tab-title");
    if (!tab) return;

    const content = tab.nextElementSibling;

    // If content is open â†’ close it
    if (content.classList.contains("active")) {
      content.classList.remove("active");
      tab.classList.remove("active");
      tab.querySelector(".icon-plus").style.display = "block";
      tab.querySelector(".icon-minus").style.display = "none";
    } else {
      // Close all tabs
      document.querySelectorAll(".pdp-tab-content-comman").forEach(el => {
        el.classList.remove("active");
      });
      document.querySelectorAll(".comman-pdp-tab-title").forEach(el => {
        el.classList.remove("active");
        el.querySelector(".icon-plus").style.display = "block";
        el.querySelector(".icon-minus").style.display = "none";
      });

      // Open the clicked tab
      content.classList.add("active");
      tab.classList.add("active");
      tab.querySelector(".icon-plus").style.display = "none";
      tab.querySelector(".icon-minus").style.display = "block";
    }
  });

});
</script>


{% endif %}


        {%- when 'alt_purchase_option' -%}
          {%- if alt_variant and alt_variant.available -%}
            <div class="alt-purchase" {{ block.shopify_attributes }}>
              <button
                type="button"
                class="alt-purchase__button"
                data-alt-buy-now
                data-alt-variant-id="{{ alt_variant.id }}"
              >
                <span>{{ alt_variant.title }}</span>
                <span class="alt-purchase__separator">-</span>
                <span>{{ alt_variant.price | money }}</span>
                <span class="alt-purchase__separator">-</span>
                Buy Now
              </button>
            </div>
          {%- endif -%}

        {%- when 'disclaimer' -%}
          {% if disclaimer.settings.text != blank %}
            <span class="disclaimer">{{ disclaimer.settings.text }}</span>
          {% endif %}
      {%- endcase -%}
    {%- endfor -%}
  {%- endform -%}

  {%- for block in complementary_blocks -%}
    {%- render 'layout-complimentary-products', _settings: block.settings, _section: _section, _product: _product -%}
  {%- endfor -%}
</product-form>

{%- assign preselected_variant = product.metafields.custom.default_selected_variant.value -%}
{%- if preselected_variant and product.selected_variant == blank -%}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const variantInput = document.querySelector('#{{ product_form_id }} input[data-variant-id="{{ preselected_variant.id }}"]');
      
      if (variantInput) {
        setTimeout(function() {
          variantInput.checked = true;
          variantInput.dispatchEvent(new Event('change', { bubbles: true }));
        }, 50);
      }
    });
  </script>
{%- endif -%}

{%- if alt_variant and alt_variant.available -%}
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const productFormContainer = document.querySelector('#layout-product-form-{{ section.id }}');
      if (!productFormContainer) return;

      const altBuyButton = productFormContainer.querySelector('[data-alt-buy-now]');
      if (!altBuyButton) return;

      altBuyButton.addEventListener('click', function () {
        const variantId = this.dataset.altVariantId;
        const mainForm = document.querySelector('#{{ product_form_id }}');

        if (mainForm && variantId) {
          const altVariantRadio = mainForm.querySelector(`[data-variant-id="${variantId}"]`);
          const mainAddToCartButton = mainForm.querySelector('[data-product-add-to-cart]');

          if (altVariantRadio && mainAddToCartButton) {
            altVariantRadio.checked = true;
            altVariantRadio.dispatchEvent(new Event('change', { bubbles: true }));

            setTimeout(function () {
              mainAddToCartButton.click();
            }, 250);
          }
        }
      });
    });
  </script>
{%- endif -%}