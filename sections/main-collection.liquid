{%- capture contentForQuerystring -%}{{ content_for_header }}{%- endcapture -%}
{%- liquid
  assign template_name = 'section-main-collection'

  assign pageUrl = contentForQuerystring | split: '"pageurl":"' | last | split: '"' | first | split: '.co.uk' | last | replace: '\/', '/' | replace: '%20', ' ' | replace: '\u0026', '&'
  assign querystring = pageUrl | split: '?' | last
  assign querystringParts = querystring | split: '&'

  assign showFiltersOnLoad = false

  for part in querystringParts
    if part contains 'lastClicked=filter'
      assign showFiltersOnLoad = true
    endif
  endfor

  assign collection_url = collection.url | append: '?'
  assign current_url = collection.url | append: '?'

  assign use_ajax_filters = true
  assign use_infinite_results = true

  for filter in collection.filters
    if filter.active_values.size > 0
      for active_value in filter.active_values
        assign url_sections_array = current_url | split: '?'

        capture apos_escaped_filter_value
          render 'apostrophe-escape', string: active_value.value
        endcapture
        capture amp_escaped_filter_value
          render 'ampersand-escape', string: apos_escaped_filter_value
        endcapture
        assign escaped_active_value = amp_escaped_filter_value | url_encode | replace: '%26%2339%3B', '%27'
        assign current_url = current_url | append: active_value.param_name | append: '=' | append: escaped_active_value | append: '&'
      endfor

      assign active_filters_exist = true
    endif

    if filter.type == 'price_range'
      if filter.min_value.value != null or filter.max_value.value != null
        if filter.min_value.value != null
          assign min_value = filter.min_value.value | money_without_currency | replace: ',', ''
          assign current_url = current_url | append: filter.min_value.param_name | append: '=' | append: min_value | append: '&'
        endif
        if filter.max_value.value != null
          assign max_value = filter.max_value.value | money_without_currency | replace: ',', ''
          assign current_url = current_url | append: filter.max_value.param_name | append: '=' | append: max_value | append: '&'
        endif
        assign active_filters_exist = true
      endif
    endif
  endfor

  assign featured_collections = collection.metafields.hero.featured_collections.value
  assign promotion = collection.metafields.custom.promotion.value
  assign use_2_col_grid = section.settings.use_2_col_grid
  assign use_add_to_cart_btn = section.settings.use_add_to_cart_btn
  assign products_per_page = 12

  if promotion != blank
    assign products_per_page = 11
  endif

  render 'file-css', _name: 'section-main-collection.css'
  render 'file-css', _name: 'snippet-layout-store-filters.css', _load_type: 'defer'
  render 'file-js', _name: 'snippet-layout-store-filters.js', _load_type: 'defer'
%}

{%- if use_2_col_grid == true -%}
  <style>
    div[data-section-id="{{ section.id }}"] {
      --mc-grid-columns: 1fr 1fr;
    }

    @media (max-width: 1023.98px) {
      div[data-section-id="{{ section.id }}"] .snippet-card-promotion {
        grid-column: span 2 !important;
      }
    }
  </style>
{%- endif -%}

<div
  class="{{- template_name }} u-space-below-lg"
  data-section-type="{{- template_name -}}"
  data-section-id="{{ section.id }}"
  id="main-collection"
  {% if use_ajax_filters %}
    data-collection-ajax
  {% endif %}
  {% if use_infinite_results %}
    data-collection-infinite-results
  {% endif %}
  data-paginate-by="{{ products_per_page }}"
>
  <div class="container">
    {%- paginate collection.products by products_per_page -%}

      {% liquid
        assign paginate_items_size = paginate.items
      %}
      {% render 'layout-collection-hero', _collection: collection, _paginate_items_size: paginate_items_size %}
      {%- if featured_collections.count > 0 -%}
        <div class="featured-collections">
          {%- for entry in featured_collections -%}
            <div>
              {% if entry.image != blank %}
                {{- entry.image | image_url: width: 80 | image_tag: alt: entry.title, loading: 'lazy' -}}
              {%- else -%}
                {{- 'image' | placeholder_svg_tag: 'placeholder-svg' -}}
              {% endif %}
              <a href="{{- entry.url -}}" class="c-btn stretched-link">{{- entry.title -}}</a>
            </div>
          {%- endfor -%}
        </div>
      {%- endif -%}
      {%- render 'layout-store-filters',
        results: collection,
        _total_items: paginate.items,
        _enable_ajax: use_ajax_filters,
        _showFiltersOnLoad: showFiltersOnLoad
      -%}

      <div class="collection-overlay{% if showFiltersOnLoad %} is-visible{% endif %}" data-collection-overlay></div>
      {%- if collection.products.size > 0 -%}
        <div id="results-container">
          {%- if promotion != blank -%}
            <style>
              .section-main-collection {
                --mc-promotion-grid-row: 3;
              }
              @media (min-width: 768px) {
                .section-main-collection {
                  {%- if paginate.items < 3 -%}
                    --mc-promotion-grid-row: 1;
                  {%- else -%}
                    --mc-promotion-grid-row: 2;
                  {%- endif -%}
                }
              }
            </style>
          {%- endif -%}
          {%- if paginate.previous -%}
            {%- assign previous_url = paginate.previous.url | default: '#' -%}
            <div class="pagination prev" data-collection-pagination-less>
              <a class="c-btn main tuna" href="{{ previous_url | url }}" data-collection-pagination-less-btn>
                {{- 'template.collection.pagination.previous' | t -}}
              </a>
            </div>
          {%- endif -%}
          <div class="grid{% if promotion != blank %} has-promos{% endif %} _{{ paginate.items }}" data-collection-products>
            {%- for product in collection.products -%}
              {%- render 'card-product', _product: product, _filters: collection.filters, _collection: collection, _use_add_to_cart_btn: use_add_to_cart_btn -%}
            {%- endfor -%}
            {%- if promotion != blank -%}
              {% render 'card-promotion', _settings: promotion -%}
            {%- endif -%}
          </div>
          {%- if paginate_items_size > products_per_page and paginate.next -%}
            {%- assign next_url = paginate.next.url | default: '#' -%}
            <div class="pagination next" data-collection-pagination-more>

              <a id="test" class="c-btn main tuna" href="{{ next_url | url }}" data-collection-pagination-more-btn>
                {{- 'template.collection.pagination.more' | t -}}
              </a>
            </div>
          {%- endif -%}
        </div>
      {%- else -%}
        <p class="u-heading-xs">{{- 'template.collection.empty' | t -}}</p>
      {%- endif -%}
    {%- endpaginate -%}
  </div>
</div>
{% schema %}
{
  "name": "t:sections.main_collection.name",
  "tag": "section",
  "settings": [
    {
      "type": "header",
      "content": "t:sections.all.header_settings.content"
    },
    {
      "type": "checkbox",
      "id": "use_2_col_grid",
      "label": "t:sections.main_collection.settings.use_2_col_grid.label",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "use_add_to_cart_btn",
      "label": "t:sections.all.use_add_to_cart_btn.label",
      "default": false
    }
  ],
  "blocks": [
  ],
  "presets": [
    {
      "name": "t:sections.main_collection.name"
    }
  ],
  "enabled_on": {
    "templates": ["collection"]
  }
}
{% endschema %}
